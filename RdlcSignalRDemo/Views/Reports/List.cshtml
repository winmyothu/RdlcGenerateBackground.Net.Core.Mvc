@model List<RdlcSignalRDemo.Models.ReportJob>
@{
    Layout = null;
    ViewData["Title"] = "Generated Reports";
}
<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>@ViewData["Title"]</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/@@microsoft/signalr@8.0.0/dist/browser/signalr.min.js"></script>
</head>
<body class="container py-4">

    <h2 class="mb-3">@ViewData["Title"]</h2>
    <div class="mb-3">
        <a href="/Reports/Index" class="btn btn-primary">Generate New Report</a>
    </div>

    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Job ID</th>
                <th>Template</th>
                <th>Status</th>
                <th>PDF</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var job in Model)
            {
                <tr>
                    <td>@job.Id</td>
                    <td>@job.ReportName</td>
                    <td id="status-@job.Id">@job.Status</td>
                    <td id="pdfcell-@job.Id">
                        @if (job.Status == JobStatus.Completed && !string.IsNullOrEmpty(job.FilePath))
                        {
                            <a href="@job.FilePath" target="_blank" class="btn btn-success btn-sm">Download</a>
                        }
                        else if (job.Status == JobStatus.Failed)
                        {
                            <span class="text-danger">Failed</span>
                        }
                        else
                        {
                            <div class="progress">
                                <div id="progress-@job.Id"
                                     class="progress-bar progress-bar-striped progress-bar-animated"
                                     role="progressbar" style="width:@job.Progress%">
                                    @job.Progress%
                                </div>
                            </div>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/reportHub")
            .build();

        connection.on("UpdateJobStatus", (jobId, status, progress, filePath) => {
            const statusCell = document.getElementById("status-" + jobId);
            const pdfCell = document.getElementById("pdfcell-" + jobId);

            if (statusCell) {
                statusCell.innerText = status;
            }

            if (pdfCell) {
                if (status === "Completed" && filePath) {
                    pdfCell.innerHTML = `<a href="${filePath}" target="_blank" class="btn btn-success btn-sm">Download</a>`;
                }
                else if (status === "Failed") {
                    pdfCell.innerHTML = `<span class="text-danger">Failed</span>`;
                }
                else {
                    pdfCell.innerHTML = `
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated"
                                 role="progressbar" style="width:${progress}%">
                                 ${progress}%
                            </div>
                        </div>`;
                }
            }
        });

        connection.start().then(async () => {
            // Join groups for all jobs in table
            document.querySelectorAll("tbody tr").forEach(row => {
                const jobIdCell = row.querySelector("td:first-child");
                if (jobIdCell) {
                    const jobId = jobIdCell.innerText.trim();
                    if (jobId) {
                        connection.invoke("JoinJobGroup", jobId);
                    }
                }
            });
        }).catch(err => console.error(err));
    </script>

</body>
</html>
